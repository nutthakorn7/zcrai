
[sources.syslog_feed]
type = "syslog"
address = "0.0.0.0:514"
mode = "tcp"

[sources.http_feed]
type = "http"
address = "0.0.0.0:8088"
encoding = "ndjson"
path = "/events"

# Collector HTTP source on port 8686
[sources.collector_feed]
type = "http"
address = "0.0.0.0:8686"
encoding = "ndjson"
path = "/events"

[transforms.parse_logs]
type = "remap"
inputs = ["syslog_feed"]
source = '''
# Basic Syslog parsing
.event_type = "syslog"
.source = "syslog_feed"
.timestamp = now()
.tenant_id = "c8abd753-3015-4508-aa7b-6bcf732934e5" # Default to system/admin tenant if unknown

# Try to extract standard fields
if exists(.message) {
  .raw_data = .message
}
'''

[transforms.parse_http]
type = "remap"
inputs = ["http_feed"]
source = '''
# HTTP JSON parsing
.event_type = .event_type || "api_log"
.source = "http_feed"
.timestamp = .timestamp || now()
.tenant_id = .tenant_id || "c8abd753-3015-4508-aa7b-6bcf732934e5"
'''

# Pass through collector events directly (already formatted)
[transforms.parse_collector]
type = "remap"
inputs = ["collector_feed"]
source = '''
# Collector events are already properly formatted
.timestamp = .timestamp || now()
'''

[sinks.clickhouse]
type = "clickhouse"
inputs = ["parse_logs", "parse_http", "parse_collector"]
endpoint = "http://zcrai_clickhouse:8123"
database = "default"
table = "security_events"
encoding.timestamp_format = "unix"

  [sinks.clickhouse.auth]
  strategy = "basic"
  user = "default"
  password = ""

  [sinks.clickhouse.batch]
  max_events = 100
  timeout_secs = 5

# ===========================================
# Host Metrics Collection (CPU, Memory, etc.)
# ===========================================

[sources.host_metrics]
type = "host_metrics"
scrape_interval_secs = 15
collectors = ["cpu", "memory", "disk", "network"]

  [sources.host_metrics.disk]
  devices.excludes = ["loop*", "dm-*"]

[transforms.format_host_metrics]
type = "remap"
inputs = ["host_metrics"]
source = '''
# Convert Vector metrics to ClickHouse format
.timestamp = now()
.host = get_hostname() ?? "unknown"

# Extract metric name from the metric structure
.metric_name = .name

# Get metric value (counter or gauge)
if exists(.counter) {
  .metric_value = .counter.value
} else if exists(.gauge) {
  .metric_value = .gauge.value
} else {
  .metric_value = 0.0
}

# Store tags as JSON labels
.labels = encode_json(.tags) ?? "{}"
'''

[sinks.clickhouse_metrics]
type = "clickhouse"
inputs = ["format_host_metrics"]
endpoint = "http://zcrai_clickhouse:8123"
database = "zcrai"
table = "host_metrics"
encoding.timestamp_format = "unix"

  [sinks.clickhouse_metrics.auth]
  strategy = "basic"
  user = "default"
  password = ""

  [sinks.clickhouse_metrics.batch]
  max_events = 50
  timeout_secs = 10

