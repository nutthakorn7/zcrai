# Vector Pipeline Configuration
# รับ events จาก Collector และส่งไป ClickHouse

[api]
enabled = true
address = "0.0.0.0:8687"

# ==================== SOURCES ====================

# รับ events จาก Collector via HTTP
[sources.collector_events]
type = "http_server"
address = "0.0.0.0:8686"
path = "/events"
encoding = "ndjson"

# ==================== TRANSFORMS ====================

# Deduplicate events based on ID
[transforms.dedupe_events]
type = "dedupe"
inputs = ["collector_events"]
fields.match = ["id"]
cache.num_events = 5000

# เพิ่ม timestamp ถ้าไม่มี
[transforms.add_timestamp]
type = "remap"
inputs = ["dedupe_events"]
source = '''
if !exists(.collected_at) {
  .collected_at = now()
}

# Parse timestamps first (Collector sends RFC3339 string)
.timestamp = parse_timestamp!(.timestamp, format: "%+")
.collected_at = parse_timestamp!(.collected_at, format: "%+")

# Format for ClickHouse DateTime (no milliseconds)
.timestamp = format_timestamp!(.timestamp, format: "%Y-%m-%d %H:%M:%S")
.collected_at = format_timestamp!(.collected_at, format: "%Y-%m-%d %H:%M:%S")

# กำหนด _time สำหรับ ClickHouse
._time = .timestamp
'''

# Normalize severity เป็น numeric
[transforms.normalize_severity]
type = "remap"
inputs = ["add_timestamp"]
source = '''
.severity_score = if .severity == "critical" { 5 } else if .severity == "high" { 4 } else if .severity == "medium" { 3 } else if .severity == "low" { 2 } else { 1 }
'''

# Flatten fields for ClickHouse
[transforms.flatten_fields]
type = "remap"
inputs = ["normalize_severity"]
source = '''
# Integration info (zcrAI)
.integration_id = .integration_id || ""
.integration_name = .integration_name || ""

# ==================== Detection Details ====================
.rule_name = .rule_name || ""
.threat_name = .threat_name || ""
.classification = .classification || ""
.confidence_level = .confidence_level || ""
.analyst_verdict = .analyst_verdict || ""
.incident_status = .incident_status || ""
.detection_engines = .detection_engines || ""
.classification_source = .classification_source || ""

# ==================== MITRE ATT&CK ====================
.mitre_attack_link = .mitre_attack_link || ""

# ==================== Response/Disposition ====================
.threat_mitigated = .threat_mitigated || false
.disposition_description = .disposition_description || ""
.response_actions = .response_actions || ""

# ==================== Console Link ====================
.console_link = .console_link || ""

# ==================== Storyline/Correlation ====================
.storyline = .storyline || ""
.control_graph_id = .control_graph_id || ""
.incident_id_ref = .incident_id || ""
.alert_ids = .alert_ids || ""

# ==================== Host Info (Extended) ====================
.host_name = .host.name || ""
.host_ip = .host.ip || ""
.host_external_ip = .host.external_ip || ""
.host_mac_address = .host.mac_address || ""
.host_os = .host.os || ""
.host_os_version = .host.os_version || ""
.host_platform = .host.platform || ""
.host_agent_id = .host.agent_id || ""
.host_agent_version = .host.agent_version || ""
.host_account_id = .host.account_id || ""
.host_account_name = .host.account_name || ""
.host_site_id = .host.site_id || ""
.host_site_name = .host.site_name || ""
.host_group_id = .host.group_id || ""
.host_group_name = .host.group_name || ""
.host_domain = .host.domain || ""
.host_ou = .host.ou || ""

# ==================== User Info ====================
.user_name = .user.name || ""
.user_domain = .user.domain || ""
.user_email = .user.email || ""

# ==================== Process Info ====================
.process_name = .process.name || ""
.process_path = .process.path || ""
.process_cmd = .process.cmd || ""
.process_pid = .process.pid || 0
.process_ppid = .process.ppid || 0
.process_sha256 = .process.sha256 || ""
.process_sha1 = .process.sha1 || ""
.process_md5 = .process.md5 || ""

# ==================== Parent Process (Attack Chain) ====================
.parent_process_name = .parent_process.name || ""
.parent_process_path = .parent_process.path || ""
.parent_process_cmd = .parent_process.cmd || ""
.parent_process_sha256 = .parent_process.sha256 || ""
.parent_process_md5 = .parent_process.md5 || ""
.parent_process_user = .parent_process.user_name || ""

# ==================== Grandparent Process (Attack Chain) ====================
.grandparent_process_name = .grandparent_process.name || ""
.grandparent_process_path = .grandparent_process.path || ""
.grandparent_process_cmd = .grandparent_process.cmd || ""
.grandparent_process_sha256 = .grandparent_process.sha256 || ""
.grandparent_process_md5 = .grandparent_process.md5 || ""
.grandparent_process_user = .grandparent_process.user_name || ""

# ==================== File Info ====================
.file_name = .file.name || ""
.file_path = .file.path || ""
.file_hash = .file.sha256 || .file.hash || .file.md5 || ""
.file_sha256 = .file.sha256 || ""
.file_md5 = .file.md5 || ""
.file_size = .file.size || 0

# ==================== Network Info ====================
.network_src_ip = .network.src_ip || ""
.network_dst_ip = .network.dst_ip || ""
.network_src_port = .network.src_port || 0
.network_dst_port = .network.dst_port || 0
.network_protocol = .network.protocol || ""
.network_direction = .network.direction || ""
.network_bytes_sent = .network.bytes_sent || 0
.network_bytes_recv = .network.bytes_recv || 0

# Serialize raw and metadata to JSON string
.raw = encode_json(.raw)
.metadata = encode_json(.metadata)

# Remove nested objects to avoid schema conflicts
del(.host)
del(.user)
del(.process)
del(.file)
del(.network)
del(.parent_process)
del(.grandparent_process)
'''

# ==================== SINKS ====================

# Select only fields that exist in ClickHouse table
[transforms.clickhouse_compatible]
type = "remap"
inputs = ["flatten_fields"]
source = '''
# Rename fields to match ClickHouse schema
.raw_data = .raw || "{}"
.process_cmdline = .process_cmd || ""
.network_port = .network_dst_port || 0

# Keep only fields that exist in ClickHouse table
# Note: id is auto-generated by ClickHouse as UUID
. = {
  "tenant_id": .tenant_id,
  "source": .source,
  "event_type": .event_type,
  "severity": .severity,
  "severity_score": .severity_score,
  "timestamp": .timestamp,
  "host_name": .host_name,
  "host_ip": .host_ip,
  "host_external_ip": .host_external_ip,
  "user_name": .user_name,
  "user_domain": .user_domain,
  "process_name": .process_name,
  "process_path": .process_path,
  "process_cmdline": .process_cmdline,
  "process_sha256": .process_sha256,
  "file_name": .file_name,
  "file_path": .file_path,
  "file_hash": .file_hash,
  "file_sha256": .file_sha256,
  "file_md5": .file_md5,
  "network_src_ip": .network_src_ip,
  "network_dst_ip": .network_dst_ip,
  "network_port": .network_port,
  "mitre_tactic": .mitre_tactic,
  "mitre_technique": .mitre_technique,
  "raw_data": .raw_data,
  "integration_id": .integration_id,
  "integration_name": .integration_name,
  "host_account_id": .host_account_id,
  "host_account_name": .host_account_name,
  "host_site_id": .host_site_id,
  "host_site_name": .host_site_name,
  "host_group_id": .host_group_id,
  "host_group_name": .host_group_name,
  "threat_name": .threat_name,
  "description": .description,
  "title": .title,
  "analyst_verdict": .analyst_verdict,
  "threat_mitigated": .threat_mitigated,
  "confidence_level": .confidence_level,
  "classification": .classification
}
'''

# ส่งไป ClickHouse
[sinks.clickhouse]
type = "clickhouse"
inputs = ["clickhouse_compatible"]
endpoint = "http://zcrai_clickhouse:8123"
database = "zcrai"
table = "security_events"
compression = "gzip"
skip_unknown_fields = true

[sinks.clickhouse.auth]
strategy = "basic"
user = "default"
password = "clickhouse"

# Batch settings - Increased for high ingestion rates
[sinks.clickhouse.batch]
max_bytes = 52428800  # 50MB (increased from 10MB)
max_events = 50000    # 50k events (increased from 10k)
timeout_secs = 30     # 30 sec (increased from 5)

# Retry settings
[sinks.clickhouse.request]
retry_attempts = 10
retry_initial_backoff_secs = 2
retry_max_duration_secs = 120
concurrency = 10      # Limit concurrent requests to ClickHouse
rate_limit_duration_secs = 1
rate_limit_num = 5    # Max 5 requests per second

# Console output for debugging (disable in production)
[sinks.console_debug]
type = "console"
inputs = ["collector_events"]
target = "stdout"

[sinks.console_debug.encoding]
codec = "json"

