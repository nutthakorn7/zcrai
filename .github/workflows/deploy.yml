name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
      - feature/ai-analytics
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 45.118.132.160 >> ~/.ssh/known_hosts

      - name: Deploy Code via Rsync
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude '.git' \
            --exclude 'dist' \
            -e ssh \
            ./ root@45.118.132.160:/root/zcrAI/

      - name: Restore Production Env
        run: |
          ssh root@45.118.132.160 "cat > /root/zcrAI/backend/api/.env <<EOF
          NODE_ENV=production
          PORT=8000
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          CLICKHOUSE_URL=http://localhost:8123
          CLICKHOUSE_DB=zcrai
          REDIS_URL=${{ secrets.REDIS_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_ACCESS_EXPIRY=15m
          JWT_REFRESH_EXPIRY=7d
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          FRONTEND_URL=https://app.zcr.ai
          SUPERADMIN_EMAIL=superadmin@zcr.ai
          SUPERADMIN_PASSWORD=${{ secrets.SUPERADMIN_PASSWORD }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          BYPASS_AUTH=false
          EOF"

      - name: Deploy with Docker Compose
        run: |
          ssh root@45.118.132.160 "cd /root/zcrAI && \
          docker-compose pull && \
          docker-compose up -d --no-recreate postgres clickhouse redis && \
          docker-compose up -d --force-recreate nginx && \
          pm2 restart zcrai-backend || pm2 start ecosystem.config.js"

      - name: Health Check
        run: |
          sleep 30
          curl -k -f https://app.zcr.ai/api/health || exit 1
          echo "âœ… Deployment successful!"
