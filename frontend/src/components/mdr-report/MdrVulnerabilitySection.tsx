import { MdrPageFooter } from './MdrPageFooter'

interface AppVulnerability {
  application: string
  cveCount: number
  topCve: string
  highestSeverity: string
  description: string
}

interface EndpointVulnerability {
  application: string
  highestSeverity: string
  endpointCount: number
  topEndpoints: string
}

interface MdrVulnerabilitySectionProps {
  appsByVulnerabilities: AppVulnerability[]
  endpointsByVulnerabilities: EndpointVulnerability[]
  recommendation: string
}

/**
 * Vulnerability Application Section
 * Shows application and endpoint vulnerabilities
 */
export function MdrVulnerabilitySection({ 
  appsByVulnerabilities, 
  endpointsByVulnerabilities,
  recommendation 
}: MdrVulnerabilitySectionProps) {
  
  const getSeverityBadge = (severity: string) => {
    switch (severity?.toLowerCase()) {
      case 'critical':
        return 'bg-red-100 text-red-800 border-red-200'
      case 'high':
        return 'bg-orange-100 text-orange-800 border-orange-200'
      case 'medium':
        return 'bg-yellow-100 text-yellow-800 border-yellow-200'
      case 'low':
        return 'bg-green-100 text-green-800 border-green-200'
      default:
        return 'bg-gray-100 text-gray-800 border-gray-200'
    }
  }

  // Simple markdown parser for bold text
  const renderMarkdown = (text: string) => {
    if (!text) return null
    const parts = text.split(/(\*\*.*?\*\*)/g)
    return parts.map((part, index) => {
      if (part.startsWith('**') && part.endsWith('**')) {
        return <strong key={index} className="font-bold text-gray-900">{part.slice(2, -2)}</strong>
      }
      return part
    })
  }
  
  // Pagination logic
  const contentPerPage = 10
  
  // Chunk apps (if empty, create 1 empty page)
  const appPages: AppVulnerability[][] = []
  if (appsByVulnerabilities.length === 0) {
    appPages.push([])
  } else {
    for (let i = 0; i < appsByVulnerabilities.length; i += contentPerPage) {
      appPages.push(appsByVulnerabilities.slice(i, i + contentPerPage))
    }
  }

  // Chunk endpoints (if empty, create 1 empty page)
  const endpointPages: EndpointVulnerability[][] = []
  if (endpointsByVulnerabilities.length === 0) {
    endpointPages.push([])
  } else {
    for (let i = 0; i < endpointsByVulnerabilities.length; i += contentPerPage) {
      endpointPages.push(endpointsByVulnerabilities.slice(i, i + contentPerPage))
    }
  }

  return (
    <>
      {/* 1. Application Vulnerabilities Pages */}
      {appPages.map((pageApps, pageIndex) => (
        <div key={`app-page-${pageIndex}`} className="mdr-page mdr-vulnerability-app-page">
          <div className="h-full flex flex-col">
            {/* Header */}
            <div className="bg-lime-500 text-white py-4 px-8">
              <h1 className="text-2xl font-bold">
                4.1 Applications by Vulnerabilities {appPages.length > 1 ? `(${pageIndex + 1}/${appPages.length})` : ''}
              </h1>
            </div>
            
            {/* Content */}
            <div className="flex-1 p-6">
              <h3 className="text-lg font-semibold text-gray-800 mb-4">
                Application Vulnerabilities List
              </h3>
              
              <table className="w-full text-sm mb-8">
                <thead>
                  <tr className="bg-gray-800 text-white">
                    <th className="py-2 px-3 text-left">Application</th>
                    <th className="py-2 px-3 text-center">CVE Count</th>
                    <th className="py-2 px-3 text-left">Top CVE</th>
                    <th className="py-2 px-3 text-center">Severity</th>
                    <th className="py-2 px-3 text-left">Description</th>
                  </tr>
                </thead>
                <tbody>
                  {pageApps.map((app, index) => (
                    <tr key={index} className="border-b border-gray-200 hover:bg-gray-50">
                      <td className="py-2 px-3 font-medium">{app.application}</td>
                      <td className="py-2 px-3 text-center font-bold text-red-600">{app.cveCount}</td>
                      <td className="py-2 px-3 font-mono text-xs">{app.topCve}</td>
                      <td className="py-2 px-3 text-center">
                        <span className={`px-2 py-1 rounded text-xs font-medium border ${getSeverityBadge(app.highestSeverity)}`}>
                          {app.highestSeverity}
                        </span>
                      </td>
                      <td className="py-2 px-3 text-xs text-gray-600 max-w-[200px] truncate">
                        {app.description}
                      </td>
                    </tr>
                  ))}
                  {pageApps.length === 0 && (
                    <tr>
                      <td colSpan={5} className="py-8 text-center text-gray-400">
                        No vulnerability data available
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
            <MdrPageFooter />
          </div>
        </div>
      ))}

      {/* 2. Endpoint Vulnerabilities Pages */}
      {endpointPages.map((pageEndpoints, pageIndex) => (
        <div key={`endpoint-page-${pageIndex}`} className="mdr-page mdr-vulnerability-endpoint-page">
          <div className="h-full flex flex-col">
            {/* Header */}
            <div className="bg-lime-500 text-white py-4 px-8">
              <h1 className="text-2xl font-bold">
                4.2 Endpoints by Vulnerabilities {endpointPages.length > 1 ? `(${pageIndex + 1}/${endpointPages.length})` : ''}
              </h1>
            </div>
            
            {/* Content */}
            <div className="flex-1 p-6">
              <h3 className="text-lg font-semibold text-gray-800 mb-4">
                Endpoint Vulnerabilities List
              </h3>
              
              <table className="w-full text-sm">
                <thead>
                  <tr className="bg-gray-800 text-white">
                    <th className="py-2 px-3 text-left">Application</th>
                    <th className="py-2 px-3 text-center">Severity</th>
                    <th className="py-2 px-3 text-center">Endpoint Count</th>
                    <th className="py-2 px-3 text-left">Top Endpoints</th>
                  </tr>
                </thead>
                <tbody>
                  {pageEndpoints.map((endpoint, index) => (
                    <tr key={index} className="border-b border-gray-200 hover:bg-gray-50">
                      <td className="py-2 px-3 font-medium">{endpoint.application}</td>
                      <td className="py-2 px-3 text-center">
                        <span className={`px-2 py-1 rounded text-xs font-medium border ${getSeverityBadge(endpoint.highestSeverity)}`}>
                          {endpoint.highestSeverity}
                        </span>
                      </td>
                      <td className="py-2 px-3 text-center font-bold">{endpoint.endpointCount}</td>
                      <td className="py-2 px-3 font-mono text-xs truncate max-w-[300px]">
                        {endpoint.topEndpoints}
                      </td>
                    </tr>
                  ))}
                  {pageEndpoints.length === 0 && (
                    <tr>
                      <td colSpan={4} className="py-8 text-center text-gray-400">
                        No endpoint vulnerability data available
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
            <MdrPageFooter />
          </div>
        </div>
      ))}
      
      {/* 3. Recommendation Page */}
      <div className="mdr-page mdr-vulnerability-recommendation-page">
        <div className="h-full flex flex-col">
          {/* Header */}
          <div className="bg-lime-500 text-white py-4 px-8">
            <h1 className="text-2xl font-bold">4.3 Vulnerability Recommendation</h1>
          </div>
          
          {/* Content */}
          <div className="flex-1 p-8 flex flex-col gap-6 overflow-hidden">
            <div className="bg-lime-50 border-l-4 border-lime-500 p-6 rounded-r-lg flex-1 overflow-hidden flex flex-col">
              <h3 className="text-lg font-semibold text-lime-800 mb-4">
                ðŸ”§ Remediation Recommendations
              </h3>
              <div className="text-gray-700 whitespace-pre-wrap leading-relaxed overflow-y-auto pr-2 text-sm">
                {renderMarkdown(recommendation || 'No vulnerability recommendations available.')}
              </div>
            </div>
            
            <div className="mt-auto grid grid-cols-2 gap-6">
              <div className="bg-blue-50 rounded-lg p-6 border border-blue-200">
                <h4 className="font-semibold text-blue-800 mb-3">ðŸ“‹ Short-term Actions</h4>
                <ul className="text-sm text-blue-700 space-y-2">
                  <li>â€¢ Review and prioritize critical CVEs</li>
                  <li>â€¢ Apply emergency patches where available</li>
                  <li>â€¢ Implement temporary mitigations</li>
                  <li>â€¢ Monitor affected systems closely</li>
                </ul>
              </div>
              
              <div className="bg-purple-50 rounded-lg p-6 border border-purple-200">
                <h4 className="font-semibold text-purple-800 mb-3">ðŸŽ¯ Long-term Strategy</h4>
                <ul className="text-sm text-purple-700 space-y-2">
                  <li>â€¢ Establish regular patching schedule</li>
                  <li>â€¢ Implement vulnerability scanning automation</li>
                  <li>â€¢ Set up software lifecycle management</li>
                  <li>â€¢ Train staff on security best practices</li>
                </ul>
              </div>
            </div>
          </div>
          
          {/* Footer */}
          <MdrPageFooter />
        </div>
      </div>
    </>
  )
}
